# UltrasonicSensor
UltrasonicSensor для визначення наявності об'єктів у малому приміщенні

![Image of Shema project UltrasonisSensor](https://github.com/lexxai/UltrasonisSensor/blob/master/shema/shema.png)


Hex файл для прошивки:
https://github.com/lexxai/UltrasonicSensor/tree/master/dist/XC8_PIC12F675/production

Release versions:
https://github.com/lexxai/UltrasonisSensor/releases


## Release v2.0.0. Button "People inside" with LED and beeps.

Після двох років експлуатації, зроблено модифікації як апаратної частини, так і програмної.
Головна модифікація це додавання це можливість показувати стан роботи ультразвукового сенсора, і за необхідністю відключати логіку визначення за сенсором.

По-перше, показ стану дозволяє полегшити правильне позиціювання сенсора, у малому приміщенні.
По-друге, якщо сенсор не може явно визначити наявність людини, людина може заявити про себе натисканням кнопки "Людина присутня". При цьому світло не вимкнеться до тієї пори поки двері не відчиняться.

У разі визначення відсутності людини, індикація, котра вбудована у кнопку "Людина присутня", починає періодично мигати. Якщо протягом 45 секунд об'єкт не визначиться знову, то світло вимкнеться. Індикація продовжує мигати, щоб у темряві модна було натиснути на кнопку. Після цього протягом 1 хвилини, ще очікується натискання кнопки, або визначення людини сенсором. Якщо змін не має, індикатор та ультразвуковий сенсор вимикається, а схема переходить до пониженого споживання енергії - сну.
Якщо людина натиснула кнопку "Людина присутня" у любий період часу, то індикатор у кнопці починає світитися постійно, до тієї пори поки не зміниться стан відчинення дверей.

Додаткове доопрацювання, це звукове сповіщення до візуального, у разі проблеми з визначенням присутності людини. Кожні 5 секунд, лунає короткий сигнал - "біп", попереджуючи про проблеми. Кількість "біпів" постійно збільшується пропорційно від 1 до 3х. Після останнього 3х кратного "біпу" буде вимкнення світла.

До схеми введено механізм аварійного відключення світла за таймером часу.
Максимальний час постійно ввімкнено світла при:

- зачинених дверях, становить приблизно 1 годину.
- відчинених дверях, становить приблизно 15 хвилин.
- Відновити роботу після аварійного вимкнення, можливо циклом відкриттям та закриттям дверей.

Програма не використовує точний лічильник часу, для пауз, між циклами опитування, а використовує режим сну, і програмований аварійний таймер "WatchDog" який виводить програму з режиму сну, на наступну команду.


## Release v1.1.0:

У даній версії там де не потрібно вимірювати відстань до об'єкту використано механізм сну - `Sleep()` замість звичайної затримки - `__delay`.  Для виходу  зі "сну" використано таймер - WatchDog. Так як у режимі не вимірювання відстані не потрібна велика точність часу, то стандартної затримки WatchDog основаної на RC (~18ms) є прийнятною для даної задачі. Якщо не потрібно використовувати механізм "сну" у програмі треба визначити визначення  для компілятора  `#define UseWatchDogForDelay 0` у `user.h`.

PS. Прошивку HEX файлу потрібно записувати до контролера PIC від’єднавши модуль UltraSound, тому що вхід ECHO сумісно використовується з VPP.

Для діагностики, якщо Вам потрібно знати відстань у см (uint16), що повертає UltraSound модуль, то можна використовувати зовнішній модуль USB RS232 TTL, під'єднавши його вхід RX RS232 до виходу контролера GP0. А також роз коментувати визначення для компілятора  `#define DEBUG_UART` в `system.h`. Швидкість з’єднання 9600 8N1. За допомогою програми [RealTerm](http://realterm.sourceforge.net) можна ефективно переглядати результати 16 бітних значень.

2017-03-20:
До схеми додано, кнопку з вбудованим світлодіодом. Ця кнопка повинна використовуватися коли буває не правильне визначення людини у приміщені. Натиснувши її, коли вона мигає червоним кольором, ми даємо знати що людина присутня. Цей признак відключить логіку визначення присутності до тої пори коки двері не відчиняться. 
Для економії проводів, і використання поточного схемного рішення, сигнал TRIG використовується як на передачу так і прийом. Для того щоб світлодіод світився збільшити треба довжину імпульсу TRIG зараз він має довжину 10мс для запуску процесу вимірювання відстані.
Програмне рішення не реалізовано поки що. 



[Translate to English](https://translate.google.com/translate?depth=1&hl=uk&ie=UTF8&prev=_t&rurl=translate.google.com.ua&sl=uk&tl=en&u=https://github.com/lexxai/UltrasonicSensor)
